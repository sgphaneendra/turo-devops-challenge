name: Deploy

on:
  push:
    branches:
      - 'main'
jobs:
  deploy:
    name: Deploy
    environment: dev
    runs-on: ubuntu-latest
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Pull kubeconfig
      working-directory: terraform
      run: |
        echo "$KUBE_CONFIG" > kubeconf.conf
        ls -l kubeconf
      env:
        KUBE_CONFIG: ${{ secrets.KUBECONFIG }}

    - name: Setup Terraform with specified version on the runner
      uses: hashicorp/setup-terraform@v2
      with:
        terraform_version: 1.3.0

    - name: Terraform init
      working-directory: terraform
      id: init
      run: terraform init 

    - name: Terraform format
      working-directory: terraform
      id: fmt
      run: terraform fmt -check

    - name: Terraform validate
      working-directory: terraform
      id: validate
      run: terraform validate

    - name: Terraform plan
      working-directory: terraform
      id: plan
      run: terraform plan
 
    - name: Terraform Apply
      working-directory: terraform
      run: terraform apply -auto-approve -input=false
